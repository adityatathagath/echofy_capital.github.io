<!-- templates/dashboard.html -->
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  <div class="space-y-8">
    <!-- Page Header -->
    <div class="text-center">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
        <i class="fas fa-tachometer-alt mr-3 text-primary-500"></i>
        Fund Manager Dashboard
      </h1>
      <p class="text-gray-600 dark:text-gray-400">Welcome back, {{ session.get('username', 'User') }}!</p>
    </div>

    <!-- KPI Cards -->
    {% if extra_metrics %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="card hover:scale-105 transform transition-all duration-200">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-plus-circle text-green-600 dark:text-green-400 text-xl"></i>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Deposits</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">₹{{ "%.2f"|format(extra_metrics.total_deposits) }}</p>
          </div>
        </div>
      </div>

      <div class="card hover:scale-105 transform transition-all duration-200">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-minus-circle text-red-600 dark:text-red-400 text-xl"></i>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Withdrawn</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">₹{{ "%.2f"|format(extra_metrics.total_withdrawn) }}</p>
          </div>
        </div>
      </div>

      <div class="card hover:scale-105 transform transition-all duration-200">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-wallet text-blue-600 dark:text-blue-400 text-xl"></i>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Current Balance</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">₹{{ "%.2f"|format(extra_metrics.current_balance) }}</p>
          </div>
        </div>
      </div>

      <div class="card hover:scale-105 transform transition-all duration-200">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-purple-600 dark:text-purple-400 text-xl"></i>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ROI</p>
            <p class="text-2xl font-bold {{ 'text-green-600 dark:text-green-400' if extra_metrics.roi >= 0 else 'text-red-600 dark:text-red-400' }}">
              {{ "%.2f"|format(extra_metrics.roi) }}%
            </p>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Cumulative Growth Chart -->
      <div class="card">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="fas fa-chart-area mr-2 text-primary-500"></i>
            Portfolio Growth
          </h3>
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-primary-500 rounded-full"></div>
            <span class="text-sm text-gray-600 dark:text-gray-400">Cumulative Value</span>
          </div>
        </div>
        <div class="relative h-80">
          <canvas id="cumulativeChart" class="w-full h-full"></canvas>
        </div>
      </div>

      <!-- Breakdown Pie Chart -->
      <div class="card">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="fas fa-chart-pie mr-2 text-primary-500"></i>
            Portfolio Breakdown
          </h3>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-primary-500 rounded-full"></div>
              <span class="text-sm text-gray-600 dark:text-gray-400">Deposits</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-accent rounded-full"></div>
              <span class="text-sm text-gray-600 dark:text-gray-400">P&L</span>
            </div>
          </div>
        </div>
        <div class="relative h-80">
          <canvas id="breakdownChart" class="w-full h-full"></canvas>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          <i class="fas fa-bolt mr-2 text-yellow-500"></i>
          Quick Actions
        </h3>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <a href="{{ url_for('export_transactions') }}" class="btn-primary">
          <i class="fas fa-download"></i>
          <span>Export Transactions</span>
        </a>
        <a href="{{ url_for('export_trades') }}" class="btn-secondary">
          <i class="fas fa-file-csv"></i>
          <span>Export Trades</span>
        </a>
        {% if session.get("role") == "admin" %}
        <a href="{{ url_for('record_trade') }}" class="btn-success">
          <i class="fas fa-plus"></i>
          <span>New Trade</span>
        </a>
        <a href="{{ url_for('add_funds') }}" class="btn-secondary">
          <i class="fas fa-money-bill-wave"></i>
          <span>Add Funds</span>
        </a>
        {% else %}
        <a href="{{ url_for('request_withdrawal') }}" class="btn-secondary">
          <i class="fas fa-hand-holding-usd"></i>
          <span>Request Withdrawal</span>
        </a>
        <a href="{{ url_for('notifications') }}" class="btn-secondary">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Include Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Parse chart data passed from Flask with proper JSON encoding
    const chartDates = {{ (chart_dates or [])|tojson }};
    const chartCumSum = {{ (chart_cum_sum or [])|tojson }};
    const depositTotal = {{ deposit_total or 0 }};
    const tradeTotal = {{ trade_total or 0 }};
    
    // Chart.js default config for dark mode
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--tw-text-opacity') ? '#374151' : '#9CA3AF';
    
    // Cumulative Growth Line Chart
    const ctxLine = document.getElementById('cumulativeChart').getContext('2d');
    const cumulativeChart = new Chart(ctxLine, {
      type: 'line',
      data: {
        labels: chartDates,
        datasets: [{
          label: 'Portfolio Value',
          data: chartCumSum,
          borderColor: '#3B82F6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#3B82F6',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#3B82F6',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: false,
            callbacks: {
              title: function(context) {
                return 'Date: ' + context[0].label;
              },
              label: function(context) {
                return 'Portfolio Value: ₹' + context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2});
              }
            }
          }
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Date',
              font: {
                weight: 'bold'
              }
            },
            grid: {
              display: false
            }
          },
          y: {
            display: true,
            title: {
              display: true,
              text: 'Amount (₹)',
              font: {
                weight: 'bold'
              }
            },
            ticks: {
              callback: function(value) {
                return '₹' + value.toLocaleString('en-IN');
              }
            }
          }
        }
      }
    });
    
    // Breakdown Pie Chart
    const ctxPie = document.getElementById('breakdownChart').getContext('2d');
    const breakdownChart = new Chart(ctxPie, {
      type: 'doughnut',
      data: {
        labels: ['Deposits', 'Profit & Loss'],
        datasets: [{
          data: [depositTotal, Math.abs(tradeTotal)],
          backgroundColor: [
            '#3B82F6',
            '#06B6D4'
          ],
          borderWidth: 0,
          hoverOffset: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#3B82F6',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const percentage = ((context.parsed / (depositTotal + Math.abs(tradeTotal))) * 100).toFixed(1);
                return context.label + ': ₹' + context.parsed.toLocaleString('en-IN', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });

    // Update chart colors for dark mode
    function updateChartColors() {
      const isDark = document.documentElement.classList.contains('dark');
      const textColor = isDark ? '#9CA3AF' : '#374151';
      const gridColor = isDark ? '#374151' : '#E5E7EB';
      
      // Update cumulative chart
      cumulativeChart.options.scales.x.ticks.color = textColor;
      cumulativeChart.options.scales.x.title.color = textColor;
      cumulativeChart.options.scales.y.ticks.color = textColor;
      cumulativeChart.options.scales.y.title.color = textColor;
      cumulativeChart.options.scales.x.grid.color = gridColor;
      cumulativeChart.options.scales.y.grid.color = gridColor;
      cumulativeChart.update();
      
      // Update pie chart
      breakdownChart.update();
    }

    // Listen for theme changes
    const observer = new MutationObserver(updateChartColors);
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    
    // Initial update
    updateChartColors();
  </script>
{% endblock %}
